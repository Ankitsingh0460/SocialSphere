'use strict';var _regenerator=require('babel-runtime/regenerator'),_regenerator2=_interopRequireDefault(_regenerator),_extends2=require('babel-runtime/helpers/extends'),_extends3=_interopRequireDefault(_extends2),_slicedToArray2=require('babel-runtime/helpers/slicedToArray'),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator'),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_classCallCheck2=require('babel-runtime/helpers/classCallCheck'),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require('babel-runtime/helpers/createClass'),_createClass3=_interopRequireDefault(_createClass2),_mongoose=require('mongoose'),_gridfsStream=require('gridfs-stream'),_gridfsStream2=_interopRequireDefault(_gridfsStream),_awaitToJs=require('await-to-js'),_awaitToJs2=_interopRequireDefault(_awaitToJs),_config=require('./config'),_config2=_interopRequireDefault(_config);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var gridFs;_mongoose.connection.once('open',function(){return gridFs=(0,_gridfsStream2.default)(_mongoose.connection.db,_mongoose.mongo)});var GridFsStorage=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck3.default)(this,a),this.getFileName=b.getFilename||_config2.default.getFilename,this.stream=b.stream||_config2.default.stream}return(0,_createClass3.default)(a,[{key:'_handleFile',value:function(){var c=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function d(e,f,g){var h,i,j,k,l,m,n;return _regenerator2.default.wrap(function(p){for(;;)switch(p.prev=p.next){case 0:return h=this.getFileName,i=this.stream,p.next=3,(0,_awaitToJs2.default)(h(e,f));case 3:j=p.sent,k=(0,_slicedToArray3.default)(j,2),l=k[0],m=k[1],l&&g(l,null),n=gridFs.createWriteStream((0,_extends3.default)({},i,{filename:m})),f.stream.pipe(n),n.on('error',g).on('close',function(q){return g(null,q)});case 11:case'end':return p.stop();}},d,this)}));return function b(){return c.apply(this,arguments)}}()},{key:'_removeFile',value:function(){var c=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function d(e,f,g){var i,j,k,l,h=f._id;return _regenerator2.default.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,(0,_awaitToJs2.default)(gridFs.exist({_id:h}));case 2:i=n.sent,j=(0,_slicedToArray3.default)(i,2),k=j[0],l=j[1],k&&g(k,null),l&&gridFs.remove({_id:h},function(o){return o?g(o,null):g(null,h)});case 8:case'end':return n.stop();}},d,this)}));return function b(){return c.apply(this,arguments)}}()}]),a}();exports.default=GridFsStorage;